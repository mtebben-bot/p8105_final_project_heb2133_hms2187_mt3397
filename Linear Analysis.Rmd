---
title: "Linear Analysis"
author: "Henry Stoddard"
date: "11/19/2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(maps)
library(plotly)
library(patchwork)
library(corrr)
library(purrr)
library(modelr)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

Importing cleaned and merged dataset

```{r}
merged_df =
  read_csv("./data/merged_df.csv")
```


```{r}
scatter_plot = 
merged_df %>% 
ggplot(aes(x=ladder_score, y = human_freedom_score)) +
  geom_point() +
  stat_smooth(method = "lm")
```

The above plot suggests a mostly positive, linear relationship between happiness score
and freedom score

Boxplot check for outliers
```{r}
box_plot1 =
  merged_df %>% 
  ggplot(aes(y = ladder_score)) +
  geom_boxplot()
box_plot2 =
  merged_df %>% 
  ggplot(aes(y = human_freedom_score)) +
  geom_boxplot()
box_plot1 + box_plot2
```
Looks like maybe one outlier for HFS

Density plots for normality
```{r}
den_plot1 =
  merged_df %>% 
  ggplot(aes(x = ladder_score)) +
  geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8)
den_plot2 =
  merged_df %>% 
  ggplot(aes(x = human_freedom_score)) +
  geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8)
den_plot1 + den_plot2
```

Checking correlation
```{r}
complete_df1 = 
  merged_df %>% 
  drop_na(ladder_score, human_freedom_score) 
cor = cor(complete_df1$ladder_score, complete_df1$human_freedom_score)

```

corrln with uncleaned data and only complete cases = 0.69, indicating corrln

now running linear model just ladder score and HFI
```{r}
linear_model = 
  lm(ladder_score ~ human_freedom_score, data = complete_df1)
linear_stats = 
  summary(linear_model)

broom::tidy(linear_model) %>% 
  select(-std.error, -statistic) %>% 
  knitr::kable(digits = 3)

broom::glance(linear_model)

complete_df1 %>% 
  modelr::add_residuals(linear_model) %>% 
  ggplot(aes(x = human_freedom_score, y = resid)) + 
  geom_violin()
```

Linear Model 2: world happiness with personal freedom and economic freedom

```{r}
complete_df2 = 
  merged_df %>% 
  drop_na(ladder_score, personal_freedom_score, economic_freedom_score)
linear_model2 = 
  lm(ladder_score ~ personal_freedom_score + economic_freedom_score, data = complete_df2)
linear_stats = 
  summary(linear_model2)

broom::tidy(linear_model2) %>% 
  select(-std.error, -statistic) %>% 
  knitr::kable(digits = 3)

broom::glance(linear_model2)

complete_df2 %>% 
  modelr::add_residuals(linear_model2) %>% 
  ggplot(aes(x = personal_freedom_score, y = resid)) + 
  geom_violin()

complete_df2 %>% 
  modelr::add_residuals(linear_model2) %>% 
  ggplot(aes(x = economic_freedom_score, y = resid)) + 
  geom_violin()
```

Linear Model 3: world happiness with freedom of/from assembly, religion, association, movement, security/safety, inheritance rights, disappearances, conflict, terrorism, rule of law, and homicide.

```{r}
complete_df3 = 
  merged_df %>% 
  drop_na(ladder_score, assembly, religion, association, movement, security_safety, inheritance_rights, disapperances_conflicts_and_terrorism, rule_of_law, homicide)

linear_model3 = 
  lm(ladder_score ~ assembly + religion + association + movement + security_safety + inheritance_rights + disapperances_conflicts_and_terrorism + rule_of_law + homicide, data = complete_df3)

linear_stats = 
  summary(linear_model3)

broom::tidy(linear_model3) %>% 
  select(-std.error, -statistic) %>% 
  knitr::kable(digits = 3)

broom::glance(linear_model3)

complete_df3 %>% 
  modelr::add_residuals(linear_model3) %>% 
  ggplot(aes(x = assembly, y = resid)) + 
  geom_violin()

complete_df3 %>% 
  modelr::add_residuals(linear_model3) %>% 
  ggplot(aes(x = religion, y = resid)) + 
  geom_violin()

complete_df3 %>% 
  modelr::add_residuals(linear_model3) %>% 
  ggplot(aes(x = association, y = resid)) + 
  geom_violin()

complete_df3 %>% 
  modelr::add_residuals(linear_model3) %>% 
  ggplot(aes(x = movement, y = resid)) + 
  geom_violin()

complete_df3 %>% 
  modelr::add_residuals(linear_model3) %>% 
  ggplot(aes(x = security_safety, y = resid)) + 
  geom_violin()

complete_df3 %>% 
  modelr::add_residuals(linear_model3) %>% 
  ggplot(aes(x = inheritance_rights, y = resid)) + 
  geom_violin()

complete_df3 %>% 
  modelr::add_residuals(linear_model3) %>% 
  ggplot(aes(x = disapperances_conflicts_and_terrorism, y = resid)) + 
  geom_violin()

complete_df3 %>% 
  modelr::add_residuals(linear_model3) %>% 
  ggplot(aes(x = rule_of_law, y = resid)) + 
  geom_violin()

complete_df3 %>% 
  modelr::add_residuals(linear_model3) %>% 
  ggplot(aes(x = homicide, y = resid)) + 
  geom_violin()
```

```{r}
merged_df %>% 
  bootstrap(1000, id = "strap_number") %>% 
  mutate(
    models = map(.x = strap, ~lm(ladder_score ~ human_freedom_score, data = .x)), 
    results = map(models, broom::tidy)
  ) %>% 
  select(strap_number, results) %>% 
  unnest(results) %>% 
  group_by(term) %>% 
  summarize(
    mean_est = mean(estimate),
    sd_est = sd(estimate)
  )
```


Things to add: bootstrapping, more advanced models 

advanced models: subtypes of freedom - assembly, religion, association, movement, security_safety, inheritance_rights, disappearances_conflicts_terrorism, rule_of_law, homicide